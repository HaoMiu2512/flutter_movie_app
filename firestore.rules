rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // CHAT ROOMS COLLECTION (NEW)
    // ============================================
    
    // Chat room metadata
    match /chatRooms/{chatRoomId} {
      // Anyone can read chat room metadata
      allow read: if true;
      
      // Only authenticated users can create/update chat room metadata
      // (automatically created when first message is sent)
      allow create, update: if request.auth != null;
      
      // No one can delete chat rooms
      allow delete: if false;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Anyone can read messages (public chat)
        allow read: if true;
        
        // Only authenticated users can create messages
        allow create: if request.auth != null
                      && request.resource.data.keys().hasAll([
                           'userId', 'userName', 'userPhotoUrl', 
                           'message', 'timestamp', 'mediaId', 'mediaType'
                         ])
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.message is string
                      && request.resource.data.message.size() > 0
                      && request.resource.data.message.size() <= 1000
                      && request.resource.data.mediaId is int
                      && request.resource.data.mediaType in ['movie', 'tv', 'trending', 'upcoming'];
        
        // Users can only update their own messages
        allow update: if request.auth != null
                      && resource.data.userId == request.auth.uid;
        
        // Users can only delete their own messages
        allow delete: if request.auth != null
                      && resource.data.userId == request.auth.uid;
      }
    }
    
    // ============================================
    // USER PROFILE RULES (EXISTING)
    // ============================================
    
    match /users/{userId} {
      // Chỉ user sở hữu mới read/write được profile của mình
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Favorites subcollection - nested bên trong users
      match /favorites/{favoriteId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Recently Viewed subcollection - nested bên trong users
      match /recently_viewed/{movieId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Block tất cả các requests khác (EXISTING)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
